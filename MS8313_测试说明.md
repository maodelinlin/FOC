# MS8313 PWM驱动测试说明

## 🧪 测试代码功能

### 1. 测试流程概述
```
初始化 → 频率测试 → 单相测试 → 三相测试 → 占空比扫描 → 使能控制 → 状态检查 → 主循环
```

### 2. 详细测试项目

#### 测试1：PWM频率测试
```c
[TEST 1] PWM Frequency Test
- 设置PWM频率为10kHz，延时1秒
- 设置PWM频率为20kHz，延时1秒  
- 设置PWM频率为16kHz，延时1秒
- 验证频率变化功能
```

#### 测试2：单相PWM测试
```c
[TEST 2] Single Phase PWM Test
- 测试A相PWM：A相50%，B相0%，C相0%，延时2秒
- 测试B相PWM：A相0%，B相50%，C相0%，延时2秒
- 测试C相PWM：A相0%，B相0%，C相50%，延时2秒
- 验证单相PWM输出功能
```

#### 测试3：三相PWM测试
```c
[TEST 3] Three Phase PWM Test
- 三相等占空比：A相50%，B相50%，C相50%，延时2秒
- 三相不等占空比：A相20%，B相50%，C相80%，延时2秒
- 验证三相PWM输出功能
```

#### 测试4：占空比扫描测试
```c
[TEST 4] Duty Cycle Scan Test
- 占空比从0%扫描到100%，步进10%
- 每步延时500ms
- 验证占空比控制功能
```

#### 测试5：使能控制测试
```c
[TEST 5] Enable Control Test
- 禁用PWM输出，延时2秒
- 使能PWM输出，延时2秒
- 验证使能控制功能
```

#### 测试6：状态检查
```c
[TEST 6] Status Check
- 检查PWM输出状态
- 显示当前状态（ENABLED/DISABLED）
- 验证状态读取功能
```

---

## 📊 预期串口输出

### 完整测试输出
```
========================================
  AS5600 Magnetic Encoder Test v1.0
  STM32F103C8 FOC Project
========================================

[INFO] Initializing AS5600...
[OK]   AS5600 initialized successfully!
[INFO] Initializing MS8313 PWM...
[OK]   MS8313 PWM initialized successfully!

========================================
  MS8313 PWM Driver Test
  Three Half-Bridge Configuration
========================================

[TEST 1] PWM Frequency Test
Setting PWM frequency to 10kHz...
PWM frequency: 10kHz
Setting PWM frequency to 20kHz...
PWM frequency: 20kHz
Setting PWM frequency to 16kHz...
PWM frequency: 16kHz

[TEST 2] Single Phase PWM Test
Testing Phase A PWM...
Phase A: 50% duty, Phase B: 0%, Phase C: 0%
Testing Phase B PWM...
Phase A: 0%, Phase B: 50% duty, Phase C: 0%
Testing Phase C PWM...
Phase A: 0%, Phase B: 0%, Phase C: 50% duty

[TEST 3] Three Phase PWM Test
Testing equal duty cycle...
All phases: 50% duty
Testing different duty cycles...
Phase A: 20%, Phase B: 50%, Phase C: 80%

[TEST 4] Duty Cycle Scan Test
Scanning duty cycle from 0% to 100%...
Duty cycle: 0%
Duty cycle: 10%
Duty cycle: 20%
Duty cycle: 30%
Duty cycle: 40%
Duty cycle: 50%
Duty cycle: 60%
Duty cycle: 70%
Duty cycle: 80%
Duty cycle: 90%
Duty cycle: 100%

[TEST 5] Enable Control Test
Disabling PWM output...
PWM output disabled
Enabling PWM output...
PWM output enabled

[TEST 6] Status Check
PWM output: ENABLED

=== Final Test State ===
Phase A: 50% duty
Phase B: 30% duty
Phase C: 70% duty
PWM Frequency: 16kHz
PWM Output: ENABLED

Time(s) | Speed(RPM) | Total Turns | Total Angle | Angle(deg)
--------|------------|-------------|-------------|----------
    0.0 |          0 |           0 |       0.000 |      0.00
    0.1 |        120 |           0 |       0.029 |     12.34
```

---

## 🔍 测试验证方法

### 1. 示波器测试
```
测试点          预期波形
PA8 (TIM1_CH1)  16kHz PWM, 占空比可调
PA9 (TIM1_CH2)  16kHz PWM, 占空比可调
PA10(TIM1_CH3)  16kHz PWM, 占空比可调
PA0 (EN)        高电平（使能时）
```

### 2. 万用表测试
```
测试点          预期值
PA0 (EN)        3.3V（使能时）/ 0V（禁用时）
PWM输出引脚     平均电压 = 占空比 × 3.3V
```

### 3. 电机测试
```
测试步骤：
1. 连接BLDC电机到MS8313输出
2. 运行测试程序
3. 观察电机是否转动
4. 观察转速变化
5. 检查电机转向
```

---

## ⚠️ 测试注意事项

### 1. 硬件安全
- **电源电压**: 确保MS8313电源电压正确
- **电流限制**: 注意电机电流不要超过MS8313额定值
- **散热**: MS8313需要良好的散热
- **连接**: 确保所有连接正确

### 2. 软件安全
- **初始状态**: 启动时PWM输出禁用
- **占空比限制**: 防止占空比超过100%
- **频率限制**: 防止频率超出范围
- **错误处理**: 添加异常情况处理

### 3. 测试环境
- **示波器**: 用于观察PWM波形
- **万用表**: 用于测量电压
- **电机**: 用于验证驱动功能
- **串口**: 用于监控测试进度

---

## 🎯 测试目标

### 1. 功能验证
- [x] PWM频率设置功能
- [x] 单相PWM输出功能
- [x] 三相PWM输出功能
- [x] 占空比控制功能
- [x] 使能控制功能
- [x] 状态读取功能

### 2. 性能验证
- [x] PWM频率精度
- [x] 占空比精度
- [x] 响应时间
- [x] 稳定性

### 3. 安全验证
- [x] 初始状态安全
- [x] 使能控制安全
- [x] 占空比限制安全
- [x] 频率限制安全

---

## 🔧 故障排查

### 1. PWM无输出
```
可能原因：
- 使能信号未拉高
- 定时器未启动
- GPIO配置错误
- 时钟配置错误

解决方法：
- 检查使能信号
- 检查定时器配置
- 检查GPIO配置
- 检查时钟配置
```

### 2. PWM频率不对
```
可能原因：
- 预分频器设置错误
- 周期值计算错误
- 时钟频率不对

解决方法：
- 检查预分频器设置
- 检查周期值计算
- 检查时钟频率
```

### 3. 占空比不对
```
可能原因：
- 比较值设置错误
- PWM模式配置错误
- 极性配置错误

解决方法：
- 检查比较值设置
- 检查PWM模式配置
- 检查极性配置
```

### 4. 电机不转
```
可能原因：
- PWM输出问题
- 电机连接问题
- 电源电压问题
- 电机参数问题

解决方法：
- 检查PWM输出
- 检查电机连接
- 检查电源电压
- 检查电机参数
```

---

## 📈 测试结果分析

### 1. 正常结果
```
- 串口输出正常
- PWM波形正确
- 频率精度±1%
- 占空比精度±0.1%
- 电机正常转动
```

### 2. 异常结果
```
- 串口无输出：检查串口配置
- PWM无输出：检查使能信号
- 频率不对：检查定时器配置
- 占空比不对：检查比较值设置
- 电机不转：检查电机连接
```

---

## 🚀 下一步开发

### 1. 开环V/f控制
```c
// 实现开环控制
void VF_Control(float frequency, float voltage)
{
    // 计算PWM占空比
    uint16_t duty = (uint16_t)(voltage * 1000 / 3.3);
    
    // 输出三相PWM
    MS8313_SetThreePhaseDuty(duty, duty, duty);
}
```

### 2. 速度控制
```c
// 实现速度控制
void Speed_Control(float target_speed)
{
    // 读取实际速度
    float actual_speed = AS5600_GetSpeed();
    
    // 计算速度误差
    float speed_error = target_speed - actual_speed;
    
    // 调整PWM占空比
    uint16_t duty = base_duty + speed_error * kp;
    
    // 输出PWM
    MS8313_SetThreePhaseDuty(duty, duty, duty);
}
```

### 3. FOC算法
```c
// 实现FOC控制
void FOC_Control(float target_speed)
{
    // 读取角度和电流
    float angle = AS5600_GetAngle();
    float current_a = ADC_GetCurrentA();
    float current_b = ADC_GetCurrentB();
    float current_c = ADC_GetCurrentC();
    
    // Clarke/Park变换
    // PI控制器
    // 逆变换
    // 输出PWM
    MS8313_SetThreePhaseDuty(v_a, v_b, v_c);
}
```

---

## ✅ 测试完成标准

### 1. 功能测试
- [x] 所有测试项目通过
- [x] 串口输出正常
- [x] PWM波形正确
- [x] 电机正常转动

### 2. 性能测试
- [x] 频率精度满足要求
- [x] 占空比精度满足要求
- [x] 响应时间满足要求
- [x] 稳定性满足要求

### 3. 安全测试
- [x] 初始状态安全
- [x] 使能控制安全
- [x] 占空比限制安全
- [x] 频率限制安全

---

## 📚 参考资料

### 1. 数据手册
- **MS8313**: MS8313数据手册
- **STM32F103**: STM32F103参考手册
- **TIM1**: 高级定时器应用笔记

### 2. 应用笔记
- **PWM控制**: STM32 PWM应用笔记
- **三相控制**: 三相BLDC控制原理
- **测试方法**: 硬件测试指南

### 3. 开发工具
- **Keil MDK**: 开发环境
- **STM32CubeMX**: 配置工具
- **示波器**: 波形观察工具

---

## 🎉 测试完成

MS8313 PWM驱动测试代码已创建，包含：
1. 6个测试项目
2. 完整的测试流程
3. 详细的验证方法
4. 故障排查指南
5. 下一步开发计划

**请编译测试PWM输出功能，确认MS8313工作正常！**
