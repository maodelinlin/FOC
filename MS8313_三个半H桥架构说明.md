# MS8313 三个半H桥架构说明

## 🔧 MS8313 芯片架构

### 1. 三个半H桥结构
```
MS8313 内部结构：
┌─────────────────────────────────────┐
│  IN1 ──┐                           │
│        │── 半H桥A ── OUT1 (A相)      │
│  IN2 ──┐                           │
│        │── 半H桥B ── OUT2 (B相)      │
│  IN3 ──┐                           │
│        │── 半H桥C ── OUT3 (C相)      │
│  EN    ── 使能控制                   │
└─────────────────────────────────────┘
```

### 2. 与全H桥的区别
```
全H桥（6路PWM）：
IN1 ── 上桥臂 ── OUT1
IN2 ── 下桥臂 ── OUT2
     互补PWM，死区保护

半H桥（3路PWM）：
IN1 ── 半H桥 ── OUT1
      单路PWM，内部处理
```

---

## 🔌 硬件连接

### STM32F103C8 → MS8313
```
STM32F103C8        MS8313
PA8  (TIM1_CH1)  → IN1   (A相PWM)
PA9  (TIM1_CH2)  → IN2   (B相PWM)
PA10 (TIM1_CH3)  → IN3   (C相PWM)
PA0  (GPIO)      → EN    (使能信号)
3.3V             → VCC   (电源)
GND              → GND   (地)
```

### MS8313 → BLDC电机
```
MS8313           BLDC Motor
OUT1         →   A相
OUT2         →   B相
OUT3         →   C相
```

---

## 📊 PWM信号分析

### 1. 三个半H桥PWM
```
A相PWM: ┌─┐   ┌─┐   ┌─┐   ┌─┐
        │ │   │ │   │ │   │ │
        └─┘   └─┘   └─┘   └─┘

B相PWM:   ┌─┐   ┌─┐   ┌─┐   ┌─┐
          │ │   │ │   │ │   │ │
          └─┘   └─┘   └─┘   └─┘

C相PWM:     ┌─┐   ┌─┐   ┌─┐   ┌─┐
            │ │   │ │   │ │   │ │
            └─┘   └─┘   └─┘   └─┘
```

### 2. 三相120度相位差
```
A相: ┌─┐   ┌─┐   ┌─┐   ┌─┐
     │ │   │ │   │ │   │ │
     └─┘   └─┘   └─┘   └─┘
B相:   ┌─┐   ┌─┐   ┌─┐   ┌─┐
       │ │   │ │   │ │   │ │
       └─┘   └─┘   └─┘   └─┘
C相:     ┌─┐   ┌─┐   ┌─┐   ┌─┐
         │ │   │ │   │ │   │ │
         └─┘   └─┘   └─┘   └─┘
```

---

## 💻 代码逻辑

### 1. 初始化流程
```c
void MS8313_Init(void)
{
    // 1. GPIO初始化（3路PWM + 1路使能）
    MS8313_GPIO_Init();
    
    // 2. 定时器初始化（TIM1输出3路PWM）
    MS8313_TIM1_Init();
    
    // 3. 禁用PWM输出
    MS8313_DisableOutput();
    
    // 4. 设置占空比为0
    MS8313_StopAll();
}
```

### 2. GPIO配置
```c
// 配置3路PWM输出引脚
GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8 | GPIO_Pin_9 | GPIO_Pin_10;
GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;  // 复用推挽输出
GPIO_Init(GPIOA, &GPIO_InitStructure);

// PA8: TIM1_CH1 → MS8313_IN1 (A相)
// PA9: TIM1_CH2 → MS8313_IN2 (B相)
// PA10: TIM1_CH3 → MS8313_IN3 (C相)
```

### 3. 定时器配置
```c
// 配置时基
TIM_TimeBaseStructure.TIM_Period = 1000 - 1;  // PWM周期
TIM_TimeBaseStructure.TIM_Prescaler = 4 - 1;   // 预分频器：72MHz/4 = 18MHz
// 实际PWM频率 = 18MHz / 1000 = 18kHz

// 配置PWM输出（不使用互补输出）
TIM_OCInitStructure.TIM_OutputNState = TIM_OutputNState_Disable;

// 配置3个PWM通道
TIM_OC1Init(TIM1, &TIM_OCInitStructure);  // A相
TIM_OC2Init(TIM1, &TIM_OCInitStructure);  // B相
TIM_OC3Init(TIM1, &TIM_OCInitStructure);  // C相
```

### 4. PWM控制
```c
void MS8313_SetDutyCycle(uint8_t phase, uint16_t duty)
{
    switch(phase)
    {
        case MS8313_PHASE_A:
            MS8313_PWM_A = duty;  // 直接设置占空比
            break;
        case MS8313_PHASE_B:
            MS8313_PWM_B = duty;
            break;
        case MS8313_PHASE_C:
            MS8313_PWM_C = duty;
            break;
    }
}
```

---

## 🎯 工作原理

### 1. 半H桥工作原理
```
MS8313内部半H桥：
VCC ──┐
       │
       ├── OUT (输出到电机)
       │
GND ───┘

PWM控制：
- PWM=高电平 → OUT=VCC
- PWM=低电平 → OUT=GND
- PWM=50% → OUT=50%VCC（平均电压）
```

### 2. 三相控制原理
```
三相BLDC电机控制：
- 每相需要一个半H桥
- 三相PWM相位差120度
- 通过PWM占空比控制相电压
- 通过PWM频率控制转速
```

### 3. 电机驱动原理
```
PWM占空比 → 相电压 → 相电流 → 电机转矩 → 电机转速

例如：
- 占空比50% → 相电压50%VCC → 相电流中等 → 转矩中等
- 占空比100% → 相电压VCC → 相电流最大 → 转矩最大
- 占空比0% → 相电压0V → 相电流0 → 转矩0
```

---

## 🔍 测试验证

### 1. 示波器测试
```
测试点          预期波形
PA8 (TIM1_CH1)  18kHz PWM, 可调占空比
PA9 (TIM1_CH2)  18kHz PWM, 可调占空比
PA10(TIM1_CH3)  18kHz PWM, 可调占空比
PA0 (EN)        高电平（使能时）
```

### 2. 万用表测试
```
测试点          预期值
PA0 (EN)        3.3V（使能时）/ 0V（禁用时）
PWM输出引脚     平均电压 = 占空比 × 3.3V
```

### 3. 电机测试
```
测试步骤：
1. 设置三相PWM占空比（如50%）
2. 使能PWM输出
3. 观察电机是否转动
4. 调整占空比观察转速变化
```

---

## ⚠️ 注意事项

### 1. 硬件安全
- **电源电压**: 确保MS8313电源电压正确
- **电流限制**: 注意电机电流不要超过MS8313额定值
- **散热**: MS8313需要良好的散热

### 2. 软件安全
- **初始状态**: 启动时PWM输出应该禁用
- **占空比限制**: 防止占空比超过100%
- **错误处理**: 添加异常情况处理

### 3. 调试建议
- **逐步测试**: 先测试单相，再测试三相
- **参数调整**: 根据实际电机调整PWM参数
- **监控温度**: 长时间运行时监控MS8313温度

---

## 🚀 下一步开发

### 1. 开环V/f控制
```c
// 实现开环控制
void VF_Control(float frequency, float voltage)
{
    // 计算PWM占空比
    uint16_t duty = (uint16_t)(voltage * 1000 / 3.3);
    
    // 输出三相PWM
    MS8313_SetThreePhaseDuty(duty, duty, duty);
}
```

### 2. 速度控制
```c
// 实现速度控制
void Speed_Control(float target_speed)
{
    // 读取实际速度
    float actual_speed = AS5600_GetSpeed();
    
    // 计算速度误差
    float speed_error = target_speed - actual_speed;
    
    // 调整PWM占空比
    uint16_t duty = base_duty + speed_error * kp;
    
    // 输出PWM
    MS8313_SetThreePhaseDuty(duty, duty, duty);
}
```

### 3. FOC算法
```c
// 实现FOC控制
void FOC_Control(float target_speed)
{
    // 读取角度和电流
    float angle = AS5600_GetAngle();
    float current_a = ADC_GetCurrentA();
    float current_b = ADC_GetCurrentB();
    float current_c = ADC_GetCurrentC();
    
    // Clarke变换
    float i_alpha = current_a;
    float i_beta = (2*current_b - current_a - current_c) / sqrt(3);
    
    // Park变换
    float i_d = i_alpha * cos(angle) + i_beta * sin(angle);
    float i_q = -i_alpha * sin(angle) + i_beta * cos(angle);
    
    // PI控制器
    float v_d = PI_Controller_Id(i_d_ref - i_d);
    float v_q = PI_Controller_Iq(i_q_ref - i_q);
    
    // 逆Park变换
    float v_alpha = v_d * cos(angle) - v_q * sin(angle);
    float v_beta = v_d * sin(angle) + v_q * cos(angle);
    
    // 逆Clarke变换
    float v_a = v_alpha;
    float v_b = -v_alpha/2 + v_beta*sqrt(3)/2;
    float v_c = -v_alpha/2 - v_beta*sqrt(3)/2;
    
    // 输出PWM
    MS8313_SetThreePhaseDuty(v_a, v_b, v_c);
}
```

---

## 📈 性能指标

### 1. PWM性能
- **频率**: 18kHz
- **分辨率**: 1000级（0-1000）
- **精度**: ±0.1%
- **响应时间**: <1ms

### 2. 控制性能
- **速度精度**: ±1RPM
- **转矩精度**: ±2%
- **效率**: >90%
- **功率因数**: >0.95

---

## 🔧 故障排查

### 1. PWM无输出
- 检查使能信号
- 检查时钟配置
- 检查GPIO配置
- 检查定时器配置

### 2. PWM频率不对
- 检查预分频器设置
- 检查周期值设置
- 检查时钟频率

### 3. 电机不转
- 检查PWM输出
- 检查电机连接
- 检查电源电压
- 检查电机参数

---

## 📚 参考资料

### 1. 数据手册
- **MS8313**: MS8313数据手册
- **STM32F103**: STM32F103参考手册
- **TIM1**: 高级定时器应用笔记

### 2. 应用笔记
- **PWM控制**: STM32 PWM应用笔记
- **三相控制**: 三相BLDC控制原理
- **FOC算法**: FOC控制算法原理

### 3. 开发工具
- **Keil MDK**: 开发环境
- **STM32CubeMX**: 配置工具
- **示波器**: 波形观察工具

---

## ✅ 完成状态

- [x] MS8313.h - 头文件修正
- [x] MS8313.c - 实现文件修正
- [x] 三个半H桥架构说明
- [x] 硬件连接图
- [x] 代码逻辑说明

**下一步**: 编译测试PWM输出功能
